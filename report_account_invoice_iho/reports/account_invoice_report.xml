<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="external_layout_background_iho">
        <t t-if="not o" t-set="o" t-value="doc"/>
        <t t-if="not company">
            <!-- Multicompany -->
            <t t-if="company_id">
                <t t-set="company" t-value="company_id"/>
            </t>
            <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
                <t t-set="company" t-value="o.company_id.sudo()"/>
            </t>
            <t t-else="else">
                <t t-set="company" t-value="res_company"/>
            </t>
        </t>
        <div t-attf-class="o_company_#{company.id}_layout article o_report_layout_background" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id" t-att-data-oe-lang="o and o.env.context.get('lang')">
            <t t-call="web.address_layout"/>
            <t t-raw="0"/>
        </div>
    </template>

    <template id="report_account_invoice_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-if="o.l10n_mx_edi_cfdi_uuid">
                    <t t-set="xml" t-value="o.l10n_mx_edi_get_xml_etree()"/>
                    <t t-set="tfd" t-value="o.l10n_mx_edi_get_tfd_etree(xml)"/>
                    <t t-set="tfd_original_string" t-value="o._get_l10n_mx_edi_cadena()"/>
                </t>
                <t t-call="report_account_invoice_iho.external_layout_background_iho">
                    <div class="page">
                        <style>
                            table{
                            width: 100%;
                            }
                        </style>
                        <div class="row">
                            <div class="col-4" style="margin-top:-9px;">
                                <img width="240" t-if="o.company_id.logo" t-att-src="'data:image/png;base64,%s' % to_text(o.company_id.logo)"/>
                                <table style="margin-top:20px;" class="col-10">
                                    <tr>
                                        <th style="text-align:center; background-color:#af000a; color:white; font-size:16px;" colspan="2">Invoice to</th>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td><strong style="color:black;">Name:</strong></td>
                                        <td><span t-field="o.partner_id"/></td>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td><strong style="color:black;"><span t-esc="o.company_id.country_id.vat_label or 'TIN'"/></strong></td>
                                        <td><span t-esc="o.partner_id.vat"/></td>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td>
                                            <strong>Fiscal Address:</strong>
                                        </td>
                                        <td>
                                            <span t-field="o.partner_id.street_name"/>
                                            <t t-if="o.partner_id.street_number"><span t-field="o.partner_id.street_number"/></t>
                                            <t t-if="o.partner_id.street_number2"><span t-field="o.partner_id.street_number2"/></t>,<br/>
                                            <t t-if="o.partner_id.street2"><span t-field="o.partner_id.street2"/><br/></t>
                                            <t t-if="o.partner_id.l10n_mx_edi_colony"><span t-field="o.partner_id.l10n_mx_edi_colony"/></t>
                                            <t t-if="o.partner_id.l10n_mx_edi_locality"><span t-field="o.partner_id.l10n_mx_edi_locality"/></t>
                                            <t t-if="o.partner_id.city"><span t-field="o.partner_id.city"/>,</t>
                                            <t t-if="o.partner_id.state_id"><span t-field="o.partner_id.state_id"/></t><br/>
                                            <span>ZIP</span>
                                            <span t-field="o.partner_id.zip"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-3 text-left" name="invoice_address" style="font-size:14px;">
                                <div>
                                    <br/>
                                    <h5 t-if="o.type == 'out_invoice' and (o.state == 'draft' or o.state == 'posted')"><strong style="color:black; font-size:25px;">INVOICE</strong></h5>
                                    <h5 t-if="o.type == 'out_refund'"><strong style="color:black; font-size:25px;">CREDIT NOTE</strong></h5>
                                </div>
                                <strong style="color:black;"><span t-esc="o.company_id.name"/><br/>
                                <span t-esc="o.company_id.country_id.vat_label or 'TIN'"/>: <span t-field="o.company_id.vat"/></strong><br/><br/>
                                <strong style="color:black;">Fiscal Address:</strong><br/>
                                <span t-field="o.company_id.street_name"/>
                                <span t-field="o.company_id.street_number"/>
                                <span t-field="o.company_id.street_number2"/><br/>
                                <t t-if="o.company_id.street2"><span t-field="o.company_id.street2"/></t>
                                <span t-field="o.company_id.l10n_mx_edi_colony"/><br/>
                                <t t-if="o.company_id.l10n_mx_edi_locality"><span t-field="o.company_id.l10n_mx_edi_locality"/><br/></t>
                                <span t-field="o.company_id.city"/>,
                                <span t-field="o.company_id.state_id"/>
                                <span>ZIP</span>
                                <span t-field="o.company_id.zip"/>
                                <br/>
                                <strong style="color:black;">Expedition Place:</strong><br/>
                                <span t-field="o.company_id.zip"/>
                            </div>
                            <div class="col-5">
                                <table>
                                    <tr>
                                        <th height="5" style="font-size:14px; text-align:center; background-color:#af000a; color:#af000a;" colspan="2">.</th>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td><strong style="color:black;">Folio:</strong></td>
                                        <td><span t-esc="o.name"/></td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_origin">
                                        <td><strong style="color:black;">CFDI Origin(<t t-esc="o.get_cfdi_related()['type']"/>):</strong></td>
                                        <td>
                                            <t t-set="count" t-value="len(o.get_cfdi_related()['related'])"/>
                                            <t t-foreach="o.get_cfdi_related()['related']" t-as="related_uuid">
                                                <span t-esc="related_uuid"/>
                                                <t t-if="count > 1">
                                                    <br/>
                                                </t>
                                            </t>
                                        </td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">Fiscal Folio:</strong></td>
                                        <td><span t-esc="tfd.get('UUID')"/></td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">Document type:</strong></td>
                                        <td>
                                            <span t-if="o.type == 'out_invoice'">I</span>
                                            <span t-if="o.type == 'out_refund'">E</span>
                                        </td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">Emission Date:</strong></td>
                                        <td><span t-if="xml.get('fecha', xml.get('Fecha', ''))" t-esc="xml.get('fecha', xml.get('Fecha', '')).replace('T', ' ')"/></td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">Payment method:</strong></td>
                                        <td><span t-if="xml.get('formaDePago', xml.get('MetodoPago'))" t-esc="xml.get('formaDePago', xml.get('MetodoPago'))"/></td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">Payment form:</strong></td>
                                        <td><span t-if="o.l10n_mx_edi_payment_method_id.code" t-esc="' - '.join([o.l10n_mx_edi_payment_method_id.code, o.l10n_mx_edi_payment_method_id.name])"/></td>
                                    </tr>
                                    <tr style="font-size:14px;" t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <td><strong style="color:black;">CFDI Use:</strong></td>
                                        <td>                                        
                                            <t t-if="xml.Receptor.get('UsoCFDI', False)" t-set="usage" t-value="xml.Receptor.get('UsoCFDI')"/>
                                            <span t-esc="usage"/> - <span t-field="o.l10n_mx_edi_usage"/>
                                        </td>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td><strong style="color:black;">Payment conditions: &amp;nbsp;</strong></td>
                                        <td><span t-field="o.invoice_payment_term_id"/></td>
                                    </tr>
                                    <tr style="font-size:14px;">
                                        <td><strong style="color:black;">Date due:</strong></td>
                                        <td><span t-field="o.invoice_date_due"/></td>
                                    </tr>
                                    <t t-if="o.invoice_origin">
                                        <tr style="font-size:14px;">
                                            <td><strong style="color:black;">Sale Order:</strong></td>
                                            <td><span t-field="o.invoice_origin"/></td>
                                        </tr>
                                    </t>
                                    <t t-if="o.ref">
                                        <tr style="font-size:14px;">
                                            <td><strong style="color:black;">Reference:</strong></td>
                                            <td><span t-field="o.ref"/></td>
                                        </tr>
                                    </t>
                                    <t  t-if="o.l10n_mx_edi_cfdi_uuid">
                                        <tr style="font-size:14px;">
                                            <td><strong style="color:black;">Fiscal Regimen:</strong></td>
                                            <td>
                                                <t t-if="xml.get('version', '') == '3.2'">
                                                    <span t-esc="xml.Emisor.RegimenFiscal.get('Regimen')"/>
                                                </t>
                                                <t t-if="xml.get('Version', '') == '3.3'">
                                                    <span t-esc="xml.Emisor.get('RegimenFiscal', '')"/>
                                                </t>
                                                <t t-if="xml.get('Version', '') == '4.0'">
                                                    <span t-esc="xml.Receptor.get('RegimenFiscalReceptor', '')"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </table>
                            </div>
                            <br/>
                        </div>
                        <t t-set="disc" t-value="0"/>
                        <div id="total" class="row" style="margin-top: 15px; margin-bottom: 10px;">
                            <div class="col-12">
                                <table>
                                    <tr style="background-color:#af000a; color:white; font-size:17px; border-bottom:1px solid #dddddd;">
                                        <td style="background-color:#af000a; color:white;" class="text-center">R</td>
                                        <td style="background-color:#af000a; color:white;" class="text-center">Quantity</td>
                                        <td style="background-color:#af000a; color:white;" class="text-center" width="10%" t-if="o.l10n_mx_edi_cfdi_uuid and xml.get('Version')">SAT Code</td>
                                        <td style="background-color:#af000a; color:white;" class="text-left">Part No.</td>
                                        <td style="background-color:#af000a; color:white;" width="40%">Description</td>
                                        <td style="background-color:#af000a; color:white;" class="text-center" t-if="o.l10n_mx_edi_cfdi_uuid and xml.get('Version')">Unit code</td>
                                        <td style="background-color:#af000a; color:white;" class="text-right">Unit Price</td>
                                        <td style="background-color:#af000a; color:white;" class="text-right">Disc.(%)</td>
                                        <td style="background-color:#af000a; color:white;" class="text-right">Amount</td>
                                    </tr>
                                    <t t-set="row_count" t-value="1"/>
                                    <tr style="font-size:16px; text-align: center; border-bottom:1px solid #dddddd;" t-foreach="o.invoice_line_ids" t-as="l">
                                        <td class="text-center">
                                            <span t-esc="row_count"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-esc="'{:.2f}'.format(l.quantity)"/>
                                            <span t-field="l.product_uom_id"  groups="product.group_uom"/>
                                        </td>
                                        <td class="text-center" t-if="o.l10n_mx_edi_cfdi_uuid and xml.get('Version')">
                                            <span t-field="l.product_id.l10n_mx_edi_code_sat_id.code"/>
                                        </td>
                                        <td class="text-left">
                                            <span t-field="l.product_id.default_code"/>
                                        </td>
                                        <td class="text-left"><span t-field="l.name"/></td>
                                        <td class="text-center" t-if="o.l10n_mx_edi_cfdi_uuid and xml.get('Version')">
                                            <span t-field="l.product_uom_id.l10n_mx_edi_code_sat_id.code"/>
                                            <span t-field="l.product_uom_id.name"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(l.price_unit)"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="l.discount"/>
                                        </td>
                                        <td class="text-right" id="subtotal">
                                            <span>$ </span><span t-esc="'{:,.2f}'.format(l.price_subtotal)"/>
                                        </td>
                                        <t t-set="row_count" t-value="row_count+1"/>
                                        <t t-set="disc" t-value="disc+l.price_unit"/>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div style="font-size:16px; margin-bottom: 10px;" class="row">
                            <div class="col-8 pull-left"> 
                                <table>
                                    <tr>
                                        <th style="background-color:#af000a; color:white;">Amount with letters</th>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span t-esc="o.l10n_mx_edi_amount_to_text()"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-4 pull-right">
                                <table class="col-12">
                                    <tr style="border-bottom:1px solid #dddddd;">
                                        <td height="10"><strong>Discount</strong></td>
                                        <td class="text-right">
                                            <t t-set="disc2" t-value="disc-o.amount_untaxed"/>
                                            <t t-esc="disc2" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom:1px solid #dddddd;">
                                        <td height="10"><strong>Subtotal</strong></td>
                                        <td class="text-right">
                                            <span t-field="o.amount_untaxed" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                    <t t-foreach="o.amount_by_group" t-as="amount_by_group">
                                        <tr style="border-bottom:1px solid #dddddd;">
                                            <td><span t-esc="amount_by_group[0]"/></td>
                                            <td class="text-right">
                                                <span t-esc="amount_by_group[3]" />
                                            </td>
                                        </tr>
                                    </t>
                                    <tr class="border-black">
                                        <td style="text-align:center; background-color:#af000a; color:white;"><strong style="color:white;">Total</strong></td>
                                        <td class="text-right">
                                            <span t-field="o.amount_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12" style="font-size:17px;">
                                <t t-set='banks' t-value="docs.env['account.journal'].search([('type', '=', 'bank'), ('company_id', '=', docs.company_id.id), ('display_on_footer', '=', True)])"/>
                                <table class="text-center" width="80%" style="font-size: 14px;">
                                    <tr>
                                        <td style="padding-top: 0.3em; padding-bottom: 0.3em;background-color: #af000a;" colspan="3">
                                            <strong style="color:white;">Please make your transfer to any of this accounts:</strong>
                                        </td>
                                    </tr>
                                    <tr style="text-align:left; border-bottom:1pt solid black;">
                                        <td width="45%">
                                            <strong style="color:black;">BANK</strong>
                                        </td>
                                        <td>
                                            <strong style="color:black;">ACCOUNT</strong>
                                        </td>
                                        <td>
                                            <strong style="color:black;">CLABE</strong>
                                        </td>

                                    </tr>
                                    <tr t-foreach="banks" t-as="bank" style="text-align:left;">
                                        <td width="45%">
                                            <span t-esc="bank.bank_id.name"/>
                                            <span t-if="bank.currency_id" t-field="bank.currency_id"/>
                                            <span t-if="not bank.currency_id" t-field="bank.company_id.currency_id"/>
                                        </td>
                                        <td>
                                            <span t-esc="bank.bank_account_id.acc_number"/>
                                        </td>
                                        <td>
                                            <span t-esc="bank.bank_account_id.l10n_mx_edi_clabe"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="row" t-if="o.l10n_mx_edi_cfdi_uuid">
                            <br/><br/>
                            <div class="col-6">
                                <strong style="font-size:20px; color:black;">Digital stamp of the emitter</strong><br/>
                                <div style="font-size:15px;" class="digital-stamp-content">
                                    <span t-esc="xml.get('sello', xml.get('Sello', 'No identificado'))"/>
                                </div>
                            </div>
                            <div class="col-6">
                                <strong style="font-size:20px; color:black;">Digital stamp SAT</strong>
                                <div style="font-size:14px;" class="digital-stamp-content">
                                    <span t-esc="tfd.get('selloSAT', tfd.get('SelloSAT', 'No identificado'))"/>
                                </div>
                            </div>
                        </div>
                        <div class="row" t-if="o.l10n_mx_edi_cfdi_uuid">
                            <br/><br/>
                            <div class="barcode col-3">
                                <t t-set="sello" t-value="xml.get('Sello', 'No identificado')[-8:]"/>
                                <img width="150" height="150" t-att-src="'/report/barcode/?type=QR&amp;value=%s' % quote_plus(
                                    'https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?' + keep_query(
                                    re=o.l10n_mx_edi_cfdi_supplier_rfc, rr=o.l10n_mx_edi_cfdi_customer_rfc,
                                    tt=o.l10n_mx_edi_cfdi_amount, id=o.l10n_mx_edi_cfdi_uuid)
                                    + '&amp;fe=%s' % quote_plus(
                                    sello, 'utf-8', 'strict', '=/').replace('%2B', '+'))"/>
                            </div>
                            <div class="col-9" t-if="o.l10n_mx_edi_cfdi_uuid">
                                <strong style="font-size:16px; color:black;">Original chain complement of digital certification SAT</strong>
                                <div style="font-size:14px;" class="digital-stamp-content">
                                    <span class="nowrap" t-if="tfd_original_string" t-esc="tfd_original_string"/>
                                    <div style="padding-top: 0.3em; padding-bottom: 0.3em;">
                                        <span>Serial number of emitter certificate:</span><span t-esc="'%s |' % xml.get('NoCertificado', 'No identificado')"/>
                                        <span>Serial number of SAT certificate:</span><span t-esc="'%s |' % tfd.get('NoCertificadoSAT', 'No identificado')"/>
                                        <span>Certification date and time:</span><span t-esc="'%s' % datetime.datetime.strptime(tfd.get('FechaTimbrado', ''), '%Y-%m-%dT%H:%M:%S').strftime('%d/%m/%Y %H:%M:%S') or 'No identificado'"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
